apiVersion: apps/v1
kind: Deployment
metadata:
    name: burner-backend
spec:
    replicas: 2
    selector:
        matchLabels:
            app.kubernetes.io/name: burner-backend
    template:
        metadata:
            labels:
                app.kubernetes.io/name: burner-backend
        spec:
            securityContext:
                runAsNonRoot: true
                runAsUser: 10001
                seccompProfile:
                    type: RuntimeDefault
            containers:
                - name: burner-backend
                  image: ghcr.io/gioppix/burner-backend:0.2
                  imagePullPolicy: Always
                  securityContext:
                      allowPrivilegeEscalation: false
                      capabilities:
                          drop:
                              - ALL
                  resources:
                      requests:
                          memory: "128Mi"
                          cpu: "1000m"
                      limits:
                          memory: "256Mi"
                          cpu: "1500m"
                  env:
                      - name: HOST
                        value: "0.0.0.0"
                      - name: PORT
                        value: "8080"
                  ports:
                      - containerPort: 8080
                  livenessProbe:
                      httpGet:
                          path: /health
                          port: 8080
                      initialDelaySeconds: 5
                      periodSeconds: 10
                      timeoutSeconds: 3
                      failureThreshold: 3
                  readinessProbe:
                      httpGet:
                          path: /health
                          port: 8080
                      initialDelaySeconds: 3
                      periodSeconds: 5
                      timeoutSeconds: 3
                      failureThreshold: 2
---
apiVersion: v1
kind: Service
metadata:
    name: burner-backend-service
    annotations:
        load-balancer.hetzner.cloud/network-zone: eu-central
        load-balancer.hetzner.cloud/use-private-ip: "true"
        load-balancer.hetzner.cloud/health-check-protocol: tcp
        load-balancer.hetzner.cloud/health-check-interval: "15s"
        load-balancer.hetzner.cloud/health-check-timeout: "10s"
        load-balancer.hetzner.cloud/health-check-retries: "3"
spec:
    selector:
        app.kubernetes.io/name: burner-backend
    ports:
        - protocol: TCP
          port: 80
          targetPort: 8080
    type: LoadBalancer
    externalTrafficPolicy: Cluster
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
    name: burner-backend-hpa
spec:
    scaleTargetRef:
        apiVersion: apps/v1
        kind: Deployment
        name: burner-backend
    minReplicas: 2
    maxReplicas: 100
    metrics:
        - type: Resource
          resource:
              name: cpu
              target:
                  type: Utilization
                  averageUtilization: 70
        - type: Resource
          resource:
              name: memory
              target:
                  type: Utilization
                  averageUtilization: 80
